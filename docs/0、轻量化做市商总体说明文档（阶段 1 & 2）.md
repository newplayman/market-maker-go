
那我先从“总纲”开始写一份给**人和写代码的模型都看得懂**的说明文档，后面我们再把每个模块拆成独立文档。

下面这份可以直接当成《轻量化做市商——总体设计说明书 v1.0》。

---

## 1. 文档目的与适用范围

**目的**

- 定义一个在币安 USDC 合约市场运行的**轻量化做市商系统**的整体设计。
    
- 覆盖 **阶段 1：无库存风险的轻量做市** 和  
    **阶段 2：动态网格 / 动态 spread 做市**。
    
- 为后续详细模块文档（策略、风控、订单管理等）提供统一的概念和接口框架，避免歧义。
    

**适用范围**

- 交易所：Binance Futures（USDC-M 永续合约为主，后续可扩展）。
    
- 账户类型：个人或机构普通账户（**散户级 fee 结构，Maker 0 手续费**）。
    
- 执行环境：新加坡 VPS，Go 语言为核心交易引擎。
    

---

## 2. 策略阶段定义

### 2.1 阶段 1：轻量做市（零库存目标）

特征：

- 持续在盘口两侧挂小额订单：
    
    - 一侧被成交 → 尽快在对侧吃单 / 或挂单平掉，**回到接近平衡仓位（inventory≈0）**。
        
- 主要收益来源：
    
    - **盘口天然价差（spread）**
        
    - 挂单 0 手续费优势
        
- 不主动积累方向性仓位，不做趋势判断。
    
- 核心目标：**小仓位、高频、低风险、稳定微利**。
    

### 2.2 阶段 2：动态网格 / 动态 spread 做市

在阶段 1 的基础上增强：

- **动态调整挂单间距和价格：**
    
    - 根据短期波动率、盘口深度、盘口不平衡等调整 spread 宽度和挂单层数。
        
- 允许有限的短时库存偏移（例如在多头环境稍微多持多单）。
    
- 核心收益来源：
    
    - 更智能的 spread 捕捉
        
    - 更高的成交率和更合理的库存利用
        

---

## 3. 业务目标与约束

### 3.1 业务目标

1. **年化收益目标（参考）：**
    
    - 阶段 1：年化 40%–120%（在合理资金规模下）
        
    - 阶段 2：年化 80%–150%
        
2. **风险目标：**
    
    - 日内回撤控制在账户权益的 1%–3% 范围内（可配置）。
        
    - 单笔策略错误不至于导致账户大幅回撤。
        
3. **运行目标：**
    
    - 支持 7×24 小时自动运行。
        
    - 具备异常自动降级 / 停机保护能力。
        

### 3.2 环境与技术约束

- 网络：
    
    - 新加坡 VPS → Binance WS 延迟约 0.2 ms（测试值）
        
- 语言：
    
    - Go（Golang）作为核心撮合和策略执行语言。
        
- 交易所约束：
    
    - API Rate Limit：下单 / 撤单频率需低于币安限制，避免被限流或风控。
        
    - 滥发无效订单 / 高频撤单可能触发交易所罚分或风控，需要限制 QPS 与撤单占比。
        

---

## 4. 核心概念定义

> 这一节是后续所有模块公用的“词典”，避免语义歧义。

- **Symbol（交易对）**：如 `BTCUSDC_PERP`。
    
- **Mid Price（中间价）**：  
    > `(best_bid + best_ask) / 2`
    
- **Spread（价差）**：  
    > `best_ask - best_bid`
    
- **Tick Size**：交易所定义的最小价格步长。
    
- **Step Size**：最小下单数量步长。
    
- **Inventory（库存 / 净头寸）**：  
    > 当前持仓数量（多头为正，空头为负，以合约张数或币数量计）。
    
- **Target Inventory（目标库存）**：
    
    - 阶段 1：目标为 0 或极小值。
        
    - 阶段 2：允许一定范围偏离，如 `[-inv_max, +inv_max]`。
        
- **Maker Order（挂单）**：挂进订单簿，被动成交。
    
- **Taker Order（吃单）**：主动敲对手盘立即成交。
    
- **Session**：策略一个连续运行周期，中断/重启后为新 session。
    

---

## 5. 整体系统架构概览

> 下图用文字描述架构各层级，后续每个模块会单独有文档。

### 5.1 主体模块列表

1. **MarketDataService（行情服务）**
    
2. **StrategyEngine（策略引擎）**
    
3. **InventoryManager（库存管理）**
    
4. **RiskControlService（风控服务）**
    
5. **OrderManager（订单管理 / OMS）**
    
6. **ExchangeGateway（交易所网关适配层）**
    
7. **ConfigService（配置与参数服务）**
    
8. **BacktestEngine & Simulator（回测与仿真）**
    
9. **Monitoring & Alerting（监控与告警）**
    
10. **Persistence & Logging（持久化与日志）**
    

下面是各模块的职责简要说明：

---

### 5.2 MarketDataService（行情服务）

**功能：**

- 连接 Binance WebSocket：
    
    - 订阅 orderbook depth、trade、ticker 等。
        
- 本地维护：
    
    - 最新 best_bid / best_ask
        
    - 最近 N 级盘口深度
        
    - 近期成交记录（用于简单波动率、成交方向统计）
        
- 提供统一接口给 StrategyEngine：
    
    - 拉取当前盘口快照
        
    - 计算简单指标（spread、短期波动率、盘口不平衡度）
        

---

### 5.3 StrategyEngine（策略引擎）

**核心职责：**

- 执行阶段 1 / 阶段 2 的做市逻辑：
    
    - 在给定 mid price、spread、inventory、风险约束下，决定：
        
        - 在哪些价位挂多少量
            
        - 是否撤单
            
        - 是否使用 taker 单平仓
            
- 与 InventoryManager、RiskControlService 协作：
    
    - 控制总体仓位
        
    - 避免在不利情况下继续挂单
        

**内部将细分：**

- `Phase1Strategy`：零库存做市逻辑
    
- `Phase2Strategy`：动态网格 + dynamic spread 逻辑
    
- `CommonLogic`：通用参数、trade event 处理等
    

---

### 5.4 InventoryManager（库存管理）

**职责：**

- 实时跟踪：
    
    - 当前仓位（多/空数量）
        
    - 平均持仓价格
        
- 提供：
    
    - `GetInventory(symbol)`
        
    - `ShouldReduceInventory(symbol)` 等接口
        
- 在阶段 1：
    
    - 尽可能保持 `inventory ≈ 0`
        
- 在阶段 2：
    
    - 控制在 `[-inv_limit, +inv_limit]` 区间内，如果超限，强制提示策略收缩一侧挂单或强制对冲。
        

---

### 5.5 RiskControlService（风控服务）

**职责：**

- 全局维度：
    
    - 账户总权益、保证金使用率、强平风险等级监控
        
    - 日内已实现 PnL、未实现 PnL、最大回撤
        
- 策略维度：
    
    - 限制单个 symbol 的：
        
        - 最大挂单数量
            
        - 最大持仓量
            
        - 最大单笔订单金额
            
- 行为维度：
    
    - 限制撤单频率 / 下单频率
        
    - 避免触发交易所风控
        

**提供决策接口给策略引擎与 OMS：**

- `CanPlaceOrder(order)` 返回允许 / 拒绝 + 原因
    
- `ShouldPanicStop()` 判断是否需要紧急停机（例如回撤超阈值）
    

---

### 5.6 OrderManager（OMS，订单管理）

**职责：**

- 统一处理所有下单、撤单、改单逻辑：
    
    - 将策略的“意图”（意向订单）转换成交易所实际 API 调用。
        
- 维护本地订单状态：
    
    - New / Partially Filled / Filled / Canceled / Rejected
        
- 通过 ExchangeGateway 调用外部 API：
    
    - 实盘与仿真使用一致接口
        

**关键点：**

- 支持批量撤单、批量下单接口。
    
- 对接风控，任何订单先过风控再发送。
    

---

### 5.7 ExchangeGateway（交易所网关适配层）

**职责：**

- 封装 Binance Futures API：
    
    - REST：下单、撤单、查询订单、查询账户信息。
        
    - WebSocket：监听成交回报、订单状态变化。
        
- 做**协议与数据结构适配**：
    
    - 把币安原始字段转换为内部统一结构（例如统一的 `Order`, `Trade`, `Position` 结构体）。
        
- 处理节流与错误重试：
    
    - 网络错误、429 限频、5xx 等重试策略。
        

---

### 5.8 ConfigService（配置与参数服务）

**职责：**

- 提供统一的配置源：
    
    - Exchange 相关：API key、base URL、交易对列表。
        
    - 策略参数：spread 配置、inventory 限制、挂单层数、动态网格参数等。
        
    - 风控参数：每日亏损上限、最大持仓等。
        
- 支持热更新（未来可选）：
    
    - 改参数无需重启进程。
        

---

### 5.9 BacktestEngine & Simulator（回测与仿真）

**职责：**

- 使用历史 K 线 / 历史盘口数据进行策略回测。
    
- 提供模拟撮合逻辑（简单的 orderbook matching）。
    
- 支持：
    
    - **离线回测模式**
        
    - **线上仿真模式（接实时行情，但不真实下单，仅本地模拟）**
        

---

### 5.10 Monitoring & Alerting（监控与告警）

**职责：**

- 输出监控指标：
    
    - 每分钟 PnL、挂单数量、成交单数、撤单次数。
        
    - 策略是否活跃（心跳）。
        
- 告警场景：
    
    - 策略停止下单超过 N 秒。
        
    - 回撤超过阈值。
        
    - 无法连接交易所。
        
    - API 报错率异常升高。
        

---

### 5.11 Persistence & Logging（持久化与日志）

**职责：**

- 记录：
    
    - 所有订单请求与回报
        
    - 所有成交记录
        
    - 关键策略决策（例如每次生成挂单前的参数）
        
- 方便：
    
    - 事后复盘
        
    - 排查 bug
        
    - 对接回测（重放日志）
        

---

## 6. 策略运行主流程（高层时序）

以单个 symbol 为例：

1. **MarketDataService** 接收行情 → 更新本地盘口与 Indicator。
    
2. **StrategyEngine** 定时 / 事件驱动被调用：
    
    - 读取：
        
        - 当前盘口数据
            
        - 当前 inventory
            
        - 当前风险状态
            
    - 产出：
        
        - 新挂单列表（Bid/Ask）
            
        - 需要撤销的订单列表
            
        - 是否需要使用 taker 平仓
            
3. **RiskControlService** 对策略提议的订单批量校验：
    
    - 不符合规则的标记为拒绝。
        
4. **OrderManager** 接收通过的订单：
    
    - 发送下单 / 撤单请求给 ExchangeGateway。
        
    - 更新本地订单状态。
        
5. **ExchangeGateway** 发送请求到 Binance：
    
    - 接收异步的成交回报、订单状态变化。
        
6. **InventoryManager** 与 **StrategyEngine** 根据成交更新 inventory 和策略内部状态。
    
7. **Monitoring** 持续采集指标并暴露 / 推送告警。
    

---

## 7. 性能与可靠性要求（高层）

- **延迟目标：**
    
    - 从收到盘口更新 → 生成新挂单 → 调用下单 API，全链路在 **5–20 ms 可接受**，目标控制在 10ms 左右。
        
- **订单频率：**
    
    - 默认限制：单 symbol 每秒下单 + 撤单次数控制在安全范围（例如 < 20 次/s，可配置）。
        
- **错误容忍与恢复：**
    
    - 如果 Binance WS/REST 暂时断开：
        
        - 自动重新连接
            
        - 在恢复前暂停策略下单
            
    - 出现异常回撤：
        
        - 风控触发“紧急平仓 / 全撤单”并进入观察状态。
            

---

## 8. 后续详细文档结构规划

接下来我会按照“**一份一份**”给你拆细：

1. 《MarketDataService 行情服务详细设计》
    
2. 《StrategyEngine – 阶段 1（零库存轻量做市）策略说明》
    
3. 《StrategyEngine – 阶段 2（动态网格 / 动态 spread）策略说明》
    
4. 《InventoryManager 库存管理模块说明》
    
5. 《RiskControlService 风控模块说明》
    
6. 《OrderManager & ExchangeGateway 订单与网关模块说明》
    
7. 《Backtest & Simulator 设计说明》
    
8. 《监控与日志规范（面向实盘排错和复盘）》
    

这些文档会尽量做到：

- 每个模块有清晰 **输入 / 输出 / 依赖** 描述；
    
- 尽量用统一的结构体命名（方便你丢给 codex / 代码生成）；
    
- 避免“模糊话”，所有策略逻辑都要能落成伪代码。
    

---

如果这份总体说明你觉得 OK，我下一份就写：

> **《StrategyEngine – 阶段 1：零库存轻量做市策略说明（含伪代码和参数定义）》**

你可以直接说“继续阶段1策略文档”，我就往下写第二份。